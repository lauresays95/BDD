<?phpglobal $pdo;//-----------------------------------------------------// Requêtes pour l'affichage des données ://-----------------------------------------------------$queryPM = $pdo->query("SELECT * FROM pm_plante_moderne JOIN pm_referentiel     ON id_pm_referentiel=FK_id_pm_referentiel JOIN pm_espece ON id_pm_espece=FK_id_pm_espece     JOIN pm_sous_espece ON id_pm_sous_espece=FK_id_pm_sous_espece JOIN pm_variete         ON id_pm_variete=FK_id_pm_variete  JOIN pm_cultivar ON id_pm_cultivar=FK_id_pm_cultivar");$pm = $queryPM->fetchAll();//-----------------------------------------------------// Fonction d'ajout, d'édition et de suppression ://-----------------------------------------------------function setAddPlanteModerne($pdo){    global $baseURL;    $nom = data_valid($_POST['nom']);    $image = data_valid($_POST['image']);    $legende = data_valid($_POST['legende']);    $diagnose = data_valid($_POST['diagnose']);    $biotope = data_valid($_POST['biotope']);    $toxicite = data_valid($_POST['toxicite']);    $identifiant = data_valid($_POST['identifiant']);    $commentaire = data_valid($_POST['commentaire']);    $FKreferentiel = data_valid($_POST['idFKreferentiel']);    $FKespece = data_valid($_POST['idFKespece']);    $FKsousespece = data_valid($_POST['idFKsousespece']);    $FKvariete = data_valid($_POST['idFKvariete']);    $FKcultivar = data_valid($_POST['idFKcultivar']);    $pdo->query("INSERT INTO pm_plante_moderne (pm_nom, pm_image_url, pm_legende_image, pm_diagnose, pm_biotope,                     pm_toxicite, pm_identifiant_reference, pm_commentaire, FK_id_pm_referentiel, FK_id_pm_espece,                     FK_id_pm_sous_espece, FK_id_pm_variete, FK_id_pm_cultivar)                     VALUES ('$nom', '$image','$legende', '$diagnose', '$biotope','$toxicite' , '$identifiant' ,                             '$commentaire' , '$FKreferentiel' , '$FKespece' , '$FKsousespece' , '$FKvariete' , '$FKcultivar');");    // Requête d'ajout a la base de données    header('Location: ' . $baseURL . 'administration/adminPlanteModerne'); // redirection vers la view    exit();}    function setModifPlanteModerne($pdo)    {        global $baseURL;        $idReferentielToEdit = $_POST['idReferentielToEdit'];        $idEspeceToEdit = $_POST['idEspeceToEdit'];        $idSousEspeceToEdit = $_POST['idSousEspeceToEdit'];        $idVarieteToEdit = $_POST['idVarieteToEdit'];        $idCultivarToEdit = $_POST['idCultivarToEdit'];        $newPlanteModerne = data_valid($_POST['newPlanteModerne']);        $newImage = data_valid($_POST['newImage']);        $newLegende = data_valid($_POST['newLegende']);        $newDiagnose = data_valid($_POST['newDiagnose']);        $newBiotope = data_valid($_POST['newBiotope']);        $newToxicite = data_valid($_POST['newToxicite']);        $newIdentifiant = data_valid($_POST['newIdentifiant']);        $newCommentaire = data_valid($_POST['newCommentaire']);        $newFKreferentiel = data_valid($_POST['IDnewFKreferentiel']);        $newFKespece = data_valid($_POST['IDnewFKespece']);        $newFKsousespece = data_valid($_POST['IDnewFKsousespece']);        $newFKvariete = data_valid($_POST['IDnewFKvariete']);        $newFKcultivar = data_valid($_POST['IDnewFKcultivar']);        $pdo->query("UPDATE pm_plante_moderne SET pm_nom='$newPlanteModerne', pm_image_url='$newImage', pm_legende_image='$newLegende',                     pm_diagnose='$newDiagnose' , pm_biotope='$newBiotope' , pm_toxicite='$newToxicite' ,                     pm_identifiant_reference='$newIdentifiant' , pm_commentaire='$newCommentaire' ,                     FK_id_pm_referentiel='$newFKreferentiel' , FK_id_pm_espece='$newFKespece' ,                     FK_id_pm_sous_espece='$newFKsousespece' , FK_id_pm_variete='$newFKvariete' ,                              FK_id_pm_cultivar='$newFKcultivar' WHERE FK_id_pm_referentiel='$idReferentielToEdit' AND                              FK_id_pm_espece='$idEspeceToEdit' AND FK_id_pm_sous_espece='$idSousEspeceToEdit' AND                              FK_id_pm_variete='$idVarieteToEdit' AND FK_id_pm_cultivar='$idCultivarToEdit'"); // Requête d'ajout a la base de données        header('Location: ' . $baseURL . 'administration/adminPlanteModerne'); // Redirection vers le profil        exit();    }    function setDelPlanteModerne($pdo)    {        global $baseURL;        $idToDel = $_POST['idToDel'];        $pdo->query("DELETE FROM pm_plante_moderne WHERE id_pm_plante_moderne='$idToDel'"); // Requête d'ajout a la base de données        header('Location: ' . $baseURL . 'administration/adminPlanteModerne'); // Redirection vers le profil        exit();    }//-----------------------------------------------------// Fonctions pour la visualisation des données ://-----------------------------------------------------function visualDataPM($pdo){    // ----------------    // Récupération des données passées en GET :    // ----------------    $nom = data_valid($_GET['nom']);    $image = data_valid($_GET['image']);    $legende = data_valid($_GET['legende']);    $diagnose = data_valid($_GET['diagnose']);    $biotope = data_valid($_GET['biotope']);    //$toxicite = data_valid($_GET['toxicite']);    $identifiant = data_valid($_GET['identifiant']);    //$commentaire = data_valid($_GET['commentaire']);    $referentiel = data_valid($_GET['referentiel']);    $espece = data_valid($_GET['espece']);    $sous_espece = data_valid($_GET['sous_espece']);    $variete = data_valid($_GET['variete']);    $cultivar = data_valid($_GET['cultivar']);    // Récupération des radio (qui ne passent pas en GEt si pas cochées)    // Création des tableau qui vont servir à la complétion de la requête    $varSelect = [];    $where = [];    $join = [];    $pm = [];    $compReq = '';    // ----------------    // Si les données existent, on les ajoutent aux tableaux d'éléments à ajouter à la requête :    // ----------------    if (!empty($nom)) {        array_push($where, ['pm_nom', '=', $nom]);    }    if (!empty($image)) {        array_push($where, ['pm_image_url', '=', $image]);    }    if (!empty($legende)) {        array_push($where, ['pm_legende_image', '=', $legende]);    }    if (!empty($diagnose)) {        array_push($where, ['pm_diagnose', '=', $diagnose]);    }    if (!empty($biotope)) {        array_push($where, ['pm_biotope', '=', $biotope]);    }    if (!empty($toxicite)) {        array_push($where, ['pm_toxicite', '=', $toxicite]);    }    if (!empty($identifiant)) {        array_push($where, ['pm_identifiant_reference', '=', $identifiant]);    }    if (!empty($commentaire)) {        array_push($where, ['pm_commentaire', '=', $commentaire]);    }    if (!empty($referentiel)) {        array_push($where, ['FK_id_pm_referentiel', '=', $referentiel]);    }    if (!empty($espece)) {        array_push($where, ['FK_id_pm_espece', '=', $espece]);    }    if (!empty($sous_espece)) {        array_push($where, ['FK_id_pm_sous_espece', '=', $sous_espece]);    }    if (!empty($variete)) {        array_push($where, ['FK_id_pm_variete', '=', $variete]);    }    if (!empty($cultivar)) {        array_push($where, ['FK_id_pm_cultivar', '=', $cultivar]);    }    if ($join != []) {        foreach ($join as $value) {            $compReq .= ' JOIN ' . $value[0] . ' ON ' . $value[1] . ' = ' . $value[2] . ' JOIN ' . $value[3] . ' ON ' . $value[4] . ' = ' . $value[5] . '';        }    }    // ----------------    // Parcours des tableaux pour formuler la suite de la requête :    // ----------------    if ($where != []) { // si le tableau WHERE n'est pas vide        $compReq .= ' WHERE'; // alors on commence la requête par WHERE        $i = 0;        foreach ($where as $value) {            if ($i == 0) {                $compReq .= ' ' . $value[0] . ' ' . $value[1] . ' "' . $value[2] . '"';                if (isset($value[3])) {                    $compReq .= $value[3];                }            } else {  // Si il ne s'agit pas de la première requête, on ajoute AND devant                $compReq .= ' AND ' . $value[0] . ' ' . $value[1] . ' "' . $value[2] . '"';                if (isset($value[3])) {                    $compReq .= $value[3];                }            }            $i += 1;        }        if (isset($date_between)) {            $compReq .= " AND " . $date_between;        }        $compReq;    } else {        if (isset($date_between)) {            $compReq .= " WHERE " . $date_between;        }    }    if (!isset($reqTabVar)) {        $reqTabVar = "";    }    if (!isset($reqHavCount)) {        $reqHavCount = "";    }    //print('SELECT * FROM texte ' . $compReq . ' ' . $reqTabVar . ' GROUP BY id_texte ' . $reqHavCount . ' ');    try {        $req = $pdo->query('SELECT id_pm_plante_moderne FROM pm_plante_moderne ' . $compReq . ' ' . $reqTabVar . ' GROUP BY id_pm_plante_moderne ' . $reqHavCount . ' ');        $pm = $req->fetchAll(PDO::FETCH_ASSOC);    } catch (PDOException $e) {        echo 'Erreur : ' . $e->getMessage();    }    return $pm;}//-----------------------------------------------------// Fonctions pour l'ajout / édit de données ://-----------------------------------------------------//-----------------------------------------------------// Fonctions pour la visualisation des données dans la fiche du texte ://-----------------------------------------------------if (isset($_GET['idPM'])) {    $id_pm = $_GET['idPM'];    $resultat = viewInfoPM($id_pm);    $informations = $resultat['informations'][0];    $pmNom = $resultat['pmNom'];    $pmImage = $resultat['pmImage'];    $pmLegende = $resultat['pmLegende'];    $pmDiagnose = $resultat['pmDiagnose'];    $pmBiotope = $resultat['pmBiotope'];    $pmToxicite = $resultat['pmToxicite'];    $pmIdentifiant = $resultat['pmIdentifiant'];    $pmCommentaire = $resultat['pmCommentaire'];}//-----------------------------------------------------// Requêtes pour l'affichage des données ://-----------------------------------------------------function viewInfoPM($id_pm){    global $pdo;    $resultat = [];    $req = $pdo->query('SELECT * FROM pm_plante_moderne WHERE id_pm_plante_moderne=' . $id_pm . ' GROUP BY id_pm_plante_moderne'); // requete sql globale//Requête dans le cas où il y a des taxons ancien correspondantes    $reqTaxon = $pdo->query('SELECT id_pm_plante_moderne, pm_nom FROM rel_ta_pm JOIN ta_taxon_ancien ON FK_id_ta_taxon_ancien = id_ta_taxon_ancien WHERE FK_id_pm_plante_moderne=' . $id_pm);//Requête s'il y a un cultivar    $reqCultivar = $pdo->query('SELECT * FROM pm_cultivar WHERE FK_id_pm_plante_moderne=' . $id_pm);//Requête pour des variétés    $reqVariete = $pdo->query('SELECT * FROM pm_variete WHERE FK_id_pm_plante_moderne=' . $id_pm);//Requête s'il y a des sous_espece    $reqSousespece = $pdo->query('SELECT * FROM pm_sous_espece WHERE FK_id_pm_plante_moderne=' . $id_pm);//Requête s'il y a un esceces et ou des genres    $reqEspece = $pdo->query('SELECT FK_id_pm_espece, FK_id_pm_genre, id_pm_espece FROM pm_espece WHERE FK_id_pm_plante_moderne  = ' . $id_pm);//requete s'il y a un referentiel    $reqReferentiel = $pdo->query('SELECT * FROM pm_referentiel WHERE FK_id_pm_plante_moderne=' . $id_pm);//Requête dans le cas où il y a des biotopes simplifiés    $reqBiotope = $pdo->query('SELECT id_biotope_simplifie, biotope_nom FROM rel_pm_biotope JOIN biotope_simplifie ON FK_id_biotope_simplifie = id_biotope_simplifie WHERE FK_id_pm_plante_moderne=' . $id_pm);    $resultat['informations'] = $req->fetchAll(PDO::FETCH_ASSOC);    $resultat['taxon'] = $reqTaxon->fetchAll(PDO::FETCH_ASSOC);    $resultat['cultivar'] = $reqCultivar->fetchAll(PDO::FETCH_ASSOC);    $resultat['variete'] = $reqVariete->fetchAll(PDO::FETCH_ASSOC);    $resultat['sous_espece'] = $reqSousespece->fetchAll(PDO::FETCH_ASSOC);    $resultat['espece'] = $reqEspece->fetchAll(PDO::FETCH_ASSOC);    $resultat['referentiel'] = $reqReferentiel->fetchAll(PDO::FETCH_ASSOC);    $resultat['biotope'] = $reqBiotope->fetchAll(PDO::FETCH_ASSOC);    return $resultat;}